function onChange(e) {
  var sheet = e.source.getActiveSheet();
  var changeType = e.changeType;
  var email = 'riliasov@list.ru';
  var subject, body;

  if (changeType === 'INSERT_ROW') {
    // Новая запись добавлена
    var lastRow = sheet.getLastRow();
    var data = sheet.getRange(lastRow, 1, 1, sheet.getLastColumn()).getValues()[0];
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var record = {};

    // Сопоставляем данные с заголовками
    headers.forEach((header, index) => {
      record[header] = data[index] || '';
    });

    subject = 'Новая запись добавлена';
    body = 'Новая запись добавлена:\n' +
           'ID: ' + record.id + '\n' +
           'Клиент: ' + record.client_last_name + ' ' + record.client_first_name + '\n' +
           'Дата: ' + (record.date ? new Date(record.date).toLocaleDateString('ru-RU') : '-') + '\n' +
           'Сумма: ' + record.payment_amount + ' ' + record.currency + '\n' +
           'Номер платежа: ' + record.payment_number + '\n' +
           'Направление: ' + record.direction + '\n' +
           'Получил: ' + record.received_by + '\n' +
           'Пакет: ' + record.package_type + '\n' +
           'Примечания: ' + record.contract_details + '\n' +
           'Создано: ' + (record.created_at ? new Date(record.created_at).toLocaleString('ru-RU') : '-');
  } else if (changeType === 'EDIT') {
    // Запись изменена
    var editedRange = e.source.getActiveRange();
    var row = editedRange.getRow();
    if (row === 1) return; // Пропускаем изменение заголовков
    var data = sheet.getRange(row, 1, 1, sheet.getLastColumn()).getValues()[0];
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var record = {};

    headers.forEach((header, index) => {
      record[header] = data[index] || '';
    });

    subject = 'Запись обновлена';
    body = 'Запись обновлена:\n' +
           'ID: ' + record.id + '\n' +
           'Клиент: ' + record.client_last_name + ' ' + record.client_first_name + '\n' +
           'Дата: ' + (record.date ? new Date(record.date).toLocaleDateString('ru-RU') : '-') + '\n' +
           'Сумма: ' + record.payment_amount + ' ' + record.currency + '\n' +
           'Номер платежа: ' + record.payment_number + '\n' +
           'Направление: ' + record.direction + '\n' +
           'Получил: ' + record.received_by + '\n' +
           'Пакет: ' + record.package_type + '\n' +
           'Примечания: ' + record.contract_details + '\n' +
           'Обновлено: ' + (record.updated_at ? new Date(record.updated_at).toLocaleString('ru-RU') : '-');
  } else if (changeType === 'REMOVE_ROW') {
    // Запись удалена (ограниченная поддержка, так как данные уже удалены)
    subject = 'Запись удалена';
    body = 'Запись была удалена из таблицы.\n' +
           'Детали недоступны, так как строка удалена.';
  } else {
    return; // Игнорируем другие изменения
  }

  // Отправка письма
  MailApp.sendEmail({
    to: email,
    subject: subject,
    body: body
  });
}

function setupTrigger() {
  // Удаляем существующие триггеры
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    ScriptApp.deleteTrigger(triggers[i]);
  }

  // Создаём новый триггер на изменение
  ScriptApp.newTrigger('onChange')
    .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
    .onChange()
    .create();
}
