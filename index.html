<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Учет доходов — Полная версия с Created/Updated</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; }
  .flatpickr-calendar { font-size: 14px; }
</style>
</head>
<body class="bg-slate-50 min-h-screen">
<script>
const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/d667e1b70zn9o';
const CLIENTS_CSV_URL = 'https://docs.google.com/spreadsheets/d/1fd2AGVMwOzs8U8wdBaNmnpD42peEommBpMe0dMA07Bg/export?format=csv&gid=1710193411';
let current = [];
let editing = null;
</script>
<div class="max-w-6xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4">Учет доходов</h1>
  <form id="form" class="space-y-4 bg-white p-4 rounded-lg shadow">
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="text-sm">Фамилия клиента *</label>
        <input list="lastNames" id="last_name" required class="w-full border rounded p-2">
        <datalist id="lastNames"></datalist>
      </div>
      <div>
        <label class="text-sm">Имя клиента *</label>
        <input list="firstNames" id="first_name" required class="w-full border rounded p-2">
        <datalist id="firstNames"></datalist>
      </div>
    </div>
    <div class="grid grid-cols-3 gap-4">
      <div>
        <label class="text-sm">Дата платежа *</label>
        <input id="date" required class="w-full border rounded p-2" placeholder="Выберите дату">
      </div>
      <div>
        <label class="text-sm">Сумма *</label>
        <input type="number" id="amount" required min="0" step="0.01" class="w-full border rounded p-2">
      </div>
      <div>
        <label class="text-sm">Валюта</label>
        <select id="currency" class="w-full border rounded p-2">
          <option>RUB</option><option>USD</option><option>EUR</option>
        </select>
      </div>
    </div>
    <div class="grid grid-cols-3 gap-4">
      <div>
        <label class="text-sm">Номер платежа</label>
        <input id="payment_number" class="w-full border rounded p-2">
      </div>
      <div>
        <label class="text-sm">Направление *</label>
        <select id="direction" required class="w-full border rounded p-2">
          <option value="">-- Выберите --</option>
          <option value="Kids">Kids</option>
          <option value="Passport">Passport</option>
          <option value="Home">Home</option>
        </select>
      </div>
      <div>
        <label class="text-sm">Кто получил *</label>
        <select id="received" required class="w-full border rounded p-2">
          <option value="">-- Выберите --</option>
          <option value="Ильясов">Ильясов</option>
          <option value="Лукьянов">Лукьянов</option>
          <option value="Другие">Другие (уточнить)</option>
        </select>
      </div>
    </div>
    <div id="received_other_block" class="hidden">
      <label class="text-sm">Уточнение кто получил</label>
      <input id="received_other" class="w-full border rounded p-2" placeholder="Введите уточнение">
    </div>
    <div>
      <label class="text-sm">Примечание</label>
      <textarea id="note" class="w-full border rounded p-2"></textarea>
    </div>
    <div class="flex gap-3">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Сохранить</button>
      <button type="button" onclick="resetForm()" class="border px-4 py-2 rounded">Очистить</button>
    </div>
  </form>
  <table class="w-full mt-6 text-sm bg-white rounded shadow">
    <thead class="bg-slate-100">
      <tr>
        <th class="p-2 text-left">Дата</th>
        <th class="p-2 text-left">Клиент</th>
        <th class="p-2 text-left">Сумма</th>
        <th class="p-2 text-left">№</th>
        <th class="p-2 text-left">Напр.</th>
        <th class="p-2 text-left">Получил</th>
        <th class="p-2 text-left">Created</th>
        <th class="p-2 text-left">Updated</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
</div>
<script>
flatpickr.localize(flatpickr.l10ns.ru);
flatpickr('#date', { altInput:true, altFormat:'d.m.Y', dateFormat:'Y-m-d', defaultDate:new Date() });

document.getElementById('received').addEventListener('change',()=>{
  document.getElementById('received_other_block').classList.toggle('hidden', document.getElementById('received').value!=='Другие');
});

function nowISO(){return new Date().toISOString();}
function fmt(v){return v?new Date(v).toLocaleString('ru-RU'):'';}
function genId(l,p){const d=new Date();return `${d.getFullYear()}${d.getMonth()+1}${d.getDate()}_${l}_${p||Math.floor(Math.random()*9999)}`;}

async function load(){
  try{const r=await fetch(SHEETDB_API_URL);current=await r.json();render();}catch(e){console.log('offline demo');}}

async function save(record){
  try{
    const res=await fetch(SHEETDB_API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:[record]})});
    if(!res.ok)throw new Error('save failed');
  }catch(e){console.warn('local mode');}
}
async function update(id,record){
  try{
    await fetch(`${SHEETDB_API_URL}/id/${encodeURIComponent(id)}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:[record]})});
  }catch(e){console.warn('local update');}
}

document.getElementById('form').addEventListener('submit',async e=>{
  e.preventDefault();
  const l=last_name.value.trim(),f=first_name.value.trim(),date=document.getElementById('date').value;
  const dir=direction.value,rec=received.value==='Другие'?`Другие (${received_other.value})`:received.value;
  if(!l||!f||!date||!dir||!rec)return alert('Заполните обязательные поля');
  const ts=nowISO();
  if(editing){
    editing.updated_at=ts;
    Object.assign(editing,{last:l,first:f,date,amount:amount.value,currency:currency.value,payment_number:payment_number.value,direction:dir,received:rec,note:note.value});
    await update(editing.id,editing);
  }else{
    const id=genId(l,payment_number.value);
    const r={id,last:l,first:f,date,amount:amount.value,currency:currency.value,payment_number:payment_number.value,direction:dir,received:rec,note:note.value,created_at:ts,updated_at:ts};
    current.push(r);
    await save(r);
  }
  render();
  resetForm();
});

function render(){
  list.innerHTML=current.map(r=>`<tr class='border-b'><td class='p-2'>${r.date}</td><td class='p-2'>${r.last} ${r.first}</td><td class='p-2'>${r.amount} ${r.currency}</td><td class='p-2'>${r.payment_number}</td><td class='p-2'>${r.direction}</td><td class='p-2'>${r.received}</td><td class='p-2'>${fmt(r.created_at)}</td><td class='p-2'>${fmt(r.updated_at)}</td><td class='p-2'><button onclick="edit('${r.id}')" class='text-blue-600'><i class='fa fa-edit'></i></button></td></tr>`).join('');
}

function edit(id){const r=current.find(x=>x.id===id);if(!r)return;editing=r;last_name.value=r.last;first_name.value=r.first;date.value=r.date;amount.value=r.amount;currency.value=r.currency;payment_number.value=r.payment_number;direction.value=r.direction;received.value=r.received.startsWith('Другие')?'Другие':r.received;note.value=r.note;}

function resetForm(){form.reset();editing=null;}
load();
</script>
</body>
</html>
